name: Catalyst App Deployment

on:
  push:
    branches:
      - main

jobs:
  build:
    environment: Production
    name: Building and Deploying Catalyst App (Frontend + Backend)
    runs-on: ubuntu-latest

    steps:
      # ===== 1Ô∏è‚É£ Clone Repository =====
      - name: Cloning Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ===== 2Ô∏è‚É£ Setup Node =====
      - name: Setting up Node 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # ===== 3Ô∏è‚É£ Install Catalyst CLI =====
      - name: Installing Zoho Catalyst CLI
        run: |
          echo "--------------------------------------------"
          echo "STEP 3: Installing Zoho Catalyst CLI"
          echo "--------------------------------------------"
          npm install -g zcatalyst-cli@latest
          echo "‚úÖ Catalyst CLI installed successfully."
          echo "--------------------------------------------"
          echo "Checking Catalyst CLI version..."
          catalyst --version || { echo '‚ùå Catalyst CLI not found!'; exit 1; }
          echo "‚úÖ Catalyst CLI verified successfully."
          echo "--------------------------------------------"

      # ===== 4Ô∏è‚É£ Build React Frontend =====
      - name: Building React Frontend
        working-directory: ./react-app
        run: |
          echo "--------------------------------------------"
          echo "STEP 4: Building React Frontend"
          echo "--------------------------------------------"
          echo "Installing frontend dependencies..."
          npm ci
          echo "‚úÖ Frontend dependencies installed."
          echo "Building React app for production..."
          CI=false npm run build
          echo "‚úÖ Frontend build completed successfully."
          echo "--------------------------------------------"

      # ===== 5Ô∏è‚É£ Install Backend Dependencies =====
      - name: Installing Backend Dependencies
        working-directory: ./functions/ci_cd_function
        run: |
          echo "--------------------------------------------"
          echo "STEP 5: Installing Backend Dependencies"
          echo "--------------------------------------------"
          npm ci --omit=dev
          echo "‚úÖ Backend dependencies installed successfully."
          echo "--------------------------------------------"

      # ===== 6Ô∏è‚É£ Show Folder & File Structure =====
      - name: üìÅ Show Project Structure
        run: |
          echo "--------------------------------------------"
          echo "STEP 6: Showing Folder and File Structure"
          echo "--------------------------------------------"
          if command -v tree >/dev/null 2>&1; then
            echo "Using 'tree' command to show structure..."
            tree -a -I 'node_modules|.git'
          else
            echo "'tree' command not found, using 'find' instead..."
            find . -type f ! -path "*/node_modules/*" ! -path "*/.git/*" | sort
          fi
          echo "--------------------------------------------"

      # ===== 7Ô∏è‚É£ Deploy to Zoho Catalyst =====
      - name: Deploy to Zoho Catalyst (Hardcoded for Testing)
        run: |
          echo "--------------------------------------------"
          echo "STEP 7: Deploying to Zoho Catalyst (Hardcoded)"
          echo "--------------------------------------------"

          # üîí TEMPORARY HARD-CODED VALUES FOR TESTING
          CATALYST_PROJECT_NAME="CI-CD"
          CATALYST_ORG="60040289923"
          CATALYST_TOKEN="m_1004.6798bf661903580989f8b9276ae7b966.dcf1e8be121bd4e2b3edc3452d2c5bdb"

          echo "Verifying Catalyst credentials..."
          echo "Project Name: $CATALYST_PROJECT_NAME"
          echo "Org ID:        $CATALYST_ORG"
          echo "Token Length:  ${#CATALYST_TOKEN}"
          echo "Current Commit: ${{ github.sha }}"
          echo "--------------------------------------------"

          if [ -z "$CATALYST_ORG" ] || [ -z "$CATALYST_PROJECT_NAME" ] || [ -z "$CATALYST_TOKEN" ]; then
            echo "‚ùå ERROR: Missing Catalyst credentials."
            exit 1
          fi

          echo "‚úÖ All Catalyst credentials verified."
          echo "Starting deployment..."

          catalyst deploy \
            --dc in \
            --project "$CATALYST_PROJECT_NAME" \
            --org "$CATALYST_ORG" \
            --token "$CATALYST_TOKEN"

          echo "‚úÖ Catalyst deployment completed successfully."
          echo "--------------------------------------------"

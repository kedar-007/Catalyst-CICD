name: Catalyst App Deployment

on:
  push:
    branches:
      - main

jobs:
  build:
    environment: Production
    name: Build, Test, and Deploy Catalyst App
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Clone Repository
      - name: Clone Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2️⃣ Setup Node
      - name: Setup Node 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 3️⃣ Install Zoho Catalyst CLI
      - name: Install Zoho Catalyst CLI
        run: |
          npm install -g zcatalyst-cli@latest
          catalyst --version

      # 4️⃣ Run Frontend Tests
      - name: Run Frontend Tests
        working-directory: ./react-app
        run: |
          npm ci
          npm test -- --watchAll=false

      # 5️⃣ Run Backend Tests
      - name: Run Backend Tests
        working-directory: ./functions/ci_cd_function
        run: |
          npm ci
          npm test

      # 6️⃣ Build React Frontend
      - name: Build React Frontend
        working-directory: ./react-app
        run: |
          npm run build

      # 7️⃣ Install Backend Production Dependencies
      - name: Install Backend Dependencies
        working-directory: ./functions/ci_cd_function
        run: |
          npm ci --omit=dev

      # 8️⃣ Deploy to Zoho Catalyst (only if tests pass)
      - name: Deploy to Zoho Catalyst
        if: success()   # Only runs if all previous steps pass
        run: |
          echo "Deploying to Zoho Catalyst..."

          CATALYST_PROJECT_NAME="${{ secrets.CATALYST_PROJECT_NAME }}"
          CATALYST_ORG="${{ secrets.CATALYST_ORG }}"
          CATALYST_TOKEN="${{ secrets.CATALYST_TOKEN }}"

          if [ -z "$CATALYST_ORG" ] || [ -z "$CATALYST_PROJECT_NAME" ] || [ -z "$CATALYST_TOKEN" ]; then
            echo "ERROR: Missing Catalyst credentials."
            exit 1
          fi

          catalyst deploy \
            --dc in \
            --verbose \
            --project "$CATALYST_PROJECT_NAME" \
            --org "$CATALYST_ORG" \
            --token "$CATALYST_TOKEN"

          echo "Catalyst deployment completed successfully."

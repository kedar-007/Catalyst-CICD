name: Catalyst App Deployment

on:
  push:
    branches:
      - main   # Trigger only when code is pushed to main branch

jobs:
  build:
    environment: Production
    name: Building and Deploying Catalyst App (Frontend + Backend)
    runs-on: ubuntu-latest

    steps:
      # ===== 1ï¸âƒ£ Clone Repository =====
      - name: ğŸ§© Cloning Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ===== 2ï¸âƒ£ Setup Node =====
      - name: ğŸ› ï¸ Setting up Node 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # ===== 3ï¸âƒ£ Install Catalyst CLI =====
      - name: âš™ï¸ Installing Zoho Catalyst CLI
        run: |
          echo "Installing Zoho Catalyst CLI..."
          npm install -g zcatalyst-cli@latest
          echo "âœ… Catalyst CLI installed successfully."

      # ===== 4ï¸âƒ£ Build React Frontend =====
      - name: ğŸ§± Building React Frontend
        working-directory: ./react-app
        run: |
          echo "Installing frontend dependencies..."
          npm ci
          echo "Building React app for production..."
          npm run build
          echo "âœ… Frontend build completed successfully."

      # ===== 5ï¸âƒ£ Install Backend Dependencies =====
      - name: ğŸª› Installing Backend Dependencies
        working-directory: ./functions/ci_cd_function
        run: |
          echo "Installing backend dependencies..."
          npm ci --omit=dev
          echo "âœ… Backend dependencies installed successfully."

      # ===== 6ï¸âƒ£ Deploy to Zoho Catalyst =====
      - name: ğŸš€ Deploying to Zoho Catalyst
        run: |
          echo "Starting deployment to Zoho Catalyst..."
          catalyst deploy \
            --project ${{ secrets.CATALYST_PROJECT_NAME }} \
            --org ${{ secrets.CATALYST_ORG }} \
            --token ${{ secrets.CATALYST_TOKEN }}
          echo "âœ… Catalyst deployment completed successfully."

      # ===== 7ï¸âƒ£ Create Release Directory =====
      - name: ğŸ“ Creating Release Directory
        run: |
          echo "Preparing release artifacts..."
          mkdir -p release/functions release/frontend
          echo "âœ… Release directories created."

      # ===== 8ï¸âƒ£ Zip Backend Function =====
      - name: ğŸ—œï¸ Creating Zip for Backend Function
        working-directory: ./functions/ci_cd_function
        run: |
          echo "Zipping backend function..."
          zip -r ../../release/functions/ci_cd_function.zip .
          echo "âœ… Backend function zip created successfully."

      # ===== 9ï¸âƒ£ Zip Frontend Build =====
      - name: ğŸ—œï¸ Creating Zip for Frontend Build
        working-directory: ./react-app/build
        run: |
          echo "Zipping frontend build..."
          zip -r ../../../release/frontend/frontend_build.zip .
          echo "âœ… Frontend build zip created successfully."

      # ===== ğŸ”Ÿ Copy Catalyst Project File =====
      - name: ğŸ“¦ Copying catalyst.json
        run: |
          echo "Copying catalyst.json into release..."
          cp catalyst.json release/catalyst.json
          echo "âœ… catalyst.json copied successfully."

      # ===== 11ï¸âƒ£ Generate Final Release ZIP =====
      - name: ğŸ“š Generating Final Release Package
        run: |
          echo "Creating final release.zip..."
          cd release && zip -r release.zip .
          echo "âœ… Final release.zip generated successfully."

      # ===== 12ï¸âƒ£ Upload Release Artifact =====
      - name: ğŸ Uploading Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: catalyst-release
          path: ./release/release.zip

      # ===== 13ï¸âƒ£ Final Log Summary =====
      - name: ğŸ§¾ Print Deployment Summary
        run: |
          echo "------------------------------------------"
          echo "âœ… Zoho Catalyst CI/CD Workflow Completed"
          echo "Project: ${{ secrets.CATALYST_PROJECT_NAME }}"
          echo "Org ID:  ${{ secrets.CATALYST_ORG }}"
          echo "Branch:  main"
          echo "Function: functions/ci_cd_function"
          echo "------------------------------------------"

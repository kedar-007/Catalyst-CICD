name: Catalyst App Deployment

on:
  push:
    branches:
      - main   # ‚úÖ Trigger only when code is pushed to main branch

jobs:
  build:
    environment: Production
    name: Building and Deploying Catalyst App (Frontend + Backend)
    runs-on: ubuntu-latest

    steps:
      # ===== 1Ô∏è‚É£ Clone Repository =====
      - name: üß© Cloning Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ===== 2Ô∏è‚É£ Setup Node =====
      - name: üõ†Ô∏è Setting up Node 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # ===== 3Ô∏è‚É£ Install Catalyst CLI =====
      - name: ‚öôÔ∏è Installing Zoho Catalyst CLI
        run: |
          echo "--------------------------------------------"
          echo "‚öôÔ∏è STEP 3: Installing Zoho Catalyst CLI"
          echo "--------------------------------------------"
          npm install -g zcatalyst-cli@latest
          echo "‚úÖ Catalyst CLI installed successfully."

      # ===== 4Ô∏è‚É£ Build React Frontend =====
      - name: üß± Building React Frontend
        working-directory: ./react-app
        run: |
          echo "--------------------------------------------"
          echo "üì¶ STEP 4: Building React Frontend"
          echo "--------------------------------------------"
          echo "Installing frontend dependencies..."
          npm ci
          echo "Building React app for production (CI=false)..."
          CI=false npm run build
          echo "‚úÖ Frontend build completed successfully."

      # ===== 5Ô∏è‚É£ Install Backend Dependencies =====
      - name: ü™õ Installing Backend Dependencies
        working-directory: ./functions/ci_cd_function
        run: |
          echo "--------------------------------------------"
          echo "üß© STEP 5: Installing Backend Dependencies"
          echo "--------------------------------------------"
          npm ci --omit=dev
          echo "‚úÖ Backend dependencies installed successfully."

      # ===== 6Ô∏è‚É£ Deploy to Zoho Catalyst =====
      - name: üöÄ Deploy to Zoho Catalyst
        env:
          CATALYST_ORG: ${{ secrets.CATALYST_ORG }}
          CATALYST_PROJECT_NAME: ${{ secrets.CATALYST_PROJECT_NAME }}
          CATALYST_TOKEN: ${{ secrets.CATALYST_TOKEN }}
        run: |
          echo "--------------------------------------------"
          echo "üöÄ STEP 6: Deploying to Zoho Catalyst"
          echo "--------------------------------------------"
          echo "üîç Verifying Catalyst credentials..."
          echo "Project Name: $CATALYST_PROJECT_NAME"
          echo "Org ID:        $CATALYST_ORG"
          echo "Token Length:  ${#CATALYST_TOKEN}"
          echo "Current Commit: ${{ github.sha }}"
          echo "--------------------------------------------"

          if [ -z "$CATALYST_ORG" ] || [ -z "$CATALYST_PROJECT_NAME" ]; then
            echo "‚ùå Error: Missing Org or Project Name!"
            exit 1
          fi

          echo "ü™∂ Starting deployment..."
          catalyst deploy \
            --project "$CATALYST_PROJECT_NAME" \
            --org "$CATALYST_ORG" \
            --token "$CATALYST_TOKEN" \
            --verbose
          echo "‚úÖ Catalyst deployment completed successfully."

      # ===== 7Ô∏è‚É£ Create Release Directory =====
      - name: üìÅ Creating Release Directory
        run: |
          echo "--------------------------------------------"
          echo "üì¶ STEP 7: Preparing release artifacts"
          echo "--------------------------------------------"
          mkdir -p release/functions release/frontend
          echo "‚úÖ Release directories created."

      # ===== 8Ô∏è‚É£ Zip Backend Function =====
      - name: üóúÔ∏è Creating Zip for Backend Function
        working-directory: ./functions/ci_cd_function
        run: |
          echo "--------------------------------------------"
          echo "üóúÔ∏è STEP 8: Zipping backend function"
          echo "--------------------------------------------"
          zip -r ../../release/functions/ci_cd_function.zip .
          echo "‚úÖ Backend function zip created successfully."

      # ===== 9Ô∏è‚É£ Zip Frontend Build =====
      - name: üóúÔ∏è Creating Zip for Frontend Build
        working-directory: ./react-app/build
        run: |
          echo "--------------------------------------------"
          echo "üóúÔ∏è STEP 9: Zipping frontend build"
          echo "--------------------------------------------"
          zip -r ../../../release/frontend/frontend_build.zip .
          echo "‚úÖ Frontend build zip created successfully."

      # ===== üîü Copy Catalyst Project File =====
      - name: üì¶ Copying catalyst.json
        run: |
          echo "--------------------------------------------"
          echo "üì¶ STEP 10: Copying catalyst.json"
          echo "--------------------------------------------"
          cp catalyst.json release/catalyst.json
          echo "‚úÖ catalyst.json copied successfully."

      # ===== 11Ô∏è‚É£ Generate Final Release ZIP =====
      - name: üìö Generating Final Release Package
        run: |
          echo "--------------------------------------------"
          echo "üìö STEP 11: Generating Final Release Package"
          echo "--------------------------------------------"
          cd release && zip -r release.zip .
          echo "‚úÖ Final release.zip generated successfully."

      # ===== 12Ô∏è‚É£ Upload Release Artifact =====
      - name: üèÅ Uploading Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: catalyst-release
          path: ./release/release.zip

      # ===== 13Ô∏è‚É£ Final Log Summary =====
      - name: üßæ Print Deployment Summary
        run: |
          echo "--------------------------------------------"
          echo "‚úÖ Zoho Catalyst CI/CD Workflow Completed"
          echo "--------------------------------------------"
          echo "Project: ${{ secrets.CATALYST_PROJECT_NAME }}"
          echo "Org ID:  ${{ secrets.CATALYST_ORG }}"
          echo "Branch:  main"
          echo "Function: functions/ci_cd_function"
          echo "Commit: $(git rev-parse --short HEAD)"
          echo "--------------------------------------------"
